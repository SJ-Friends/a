<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>ì¼ìƒì„ ì—¬í–‰ì²˜ëŸ¼ ì¼ì • ëª©ë¡</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <style>
    th:nth-child(3), td:nth-child(3) { min-width: 120px; }
    th:nth-child(4), td:nth-child(4) { min-width: 80px; }
    th:nth-child(5), td:nth-child(5) { min-width: 80px; }
    th:nth-child(8), td:nth-child(8) { min-width: 120px; }
    th:nth-child(9), td:nth-child(9) { min-width: 90px; }
    th:nth-child(10), td:nth-child(10),
    th:nth-child(11), td:nth-child(11) { min-width: 70px; }

    body { font-family: 'Segoe UI', sans-serif; padding: 30px; max-width: 1000px; margin: auto; }
    .header { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .header img { height: 40px; }
    .header h1 { margin: 0; font-size: 1.6em; }
    .top-bar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px; }
    .button-group { display: flex; gap: 10px; align-items: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 14px; }
    th { background-color: #f4f4f4; }
    button { padding: 6px 12px; cursor: pointer; border: none; border-radius: 4px; background-color: #1d72b8; color: white; }
    button:hover { background-color: #135a96; }
    select, input[type="checkbox"] { padding: 6px; }
    label { margin-right: 8px; }
    .tooltip {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }
    .link-button {
      color: #0077cc;
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="header">
    <img alt="ë¡œê³ " src="logo.jpg"/>
    <h1>ì¼ìƒì„ ì—¬í–‰ì²˜ëŸ¼ ì¼ì • ëª©ë¡</h1>
  </div>

  <div class="top-bar">
    <div>
      <label for="sort">ì •ë ¬ ê¸°ì¤€:</label>
      <select id="sort">
        <option value="date_s">ì‹œì‘ ë‚ ì§œ</option>
        <option selected value="date_e">ì¢…ë£Œ ë‚ ì§œ</option>
        <option value="created_at">ì…ë ¥ ë‚ ì§œ</option>
      </select>
    </div>
    <div class="button-group">
      <label><input id="showDone" type="checkbox" checked/> ì™„ë£Œ í¬í•¨</label>
      <label><input id="showReserved" type="checkbox"/> ì˜ˆì•½ì™„ë£Œ í¬í•¨</label>
      <button onclick="location.href='index.html'">â• ë“±ë¡í•˜ê¸°</button>
      <button onclick="location.href='cal.html'">ğŸ“… ë‹¬ë ¥ ë³´ê¸°</button>
      <button onclick="location.href='cal_res.html'">ğŸ“… ì˜ˆì•½ìº˜ë¦°ë”</button>
    </div>
  </div>

  <table id="schedule-table">
    <thead>
      <tr>
        <th>ì™„ë£Œ</th>
        <th>ì˜ˆì•½</th>
        <th>ì—…ì²´ëª…</th>
        <th>ë¹„ìš©</th>
        <th>ìœ„ì¹˜</th>
        <th>ì‹œì‘ì¼</th>
        <th>ì¢…ë£Œì¼</th>
        <th>ë¶ˆê°€ëŠ¥ ìš”ì¼</th>
        <th>ì²´í—˜ë‹¨</th>
        <th>ë©”ëª¨</th>
        <th>ì‚­ì œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const supabase = window.supabase.createClient(
      'https://xxmtxuhcdzidhrefrvwf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4bXR4dWhjZHppZGhyZWZydndmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQwODAyNTQsImV4cCI6MjA1OTY1NjI1NH0.TaCCDlJvKrif_pZY038Qkglip8h-Qqjp2w2GlKwvoVg'
    );

    const dayNames = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
    const dayKor = { mon:'ì›”', tue:'í™”', wed:'ìˆ˜', thu:'ëª©', fri:'ê¸ˆ', sat:'í† ', sun:'ì¼' };

    function formatShortDate(dateStr) {
      if (!dateStr) return '';
      const parts = dateStr.split('-');
      return parts.length === 3 ? `${parts[1]}/${parts[2]}` : dateStr;
    }

    async function loadSchedules(sortBy = 'date_e') {
      const showDone = document.getElementById('showDone').checked;
      const showReserved = document.getElementById('showReserved').checked;

      let query = supabase.from('sche').select('*').order(sortBy, { ascending: true });
      const { data, error } = await query;
      if (error) return alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');

      let filtered = data;
      if (!showDone) filtered = filtered.filter(item => item.done !== true && item.done !== 'true');
      if (!showReserved) filtered = filtered.filter(item => item.res_c !== true && item.res_c !== 'true');

      const tbody = document.querySelector('#schedule-table tbody');
      tbody.innerHTML = '';

      filtered.forEach(item => {
        const tr = document.createElement('tr');
        const unavailable = dayNames.filter(day => item[day] !== 'Y').map(day => dayKor[day]).join(', ');
        const mapQuery = encodeURIComponent(`${item.title} ${item.loca}`);
        const mapLink = `https://map.naver.com/v5/search/${mapQuery}`;

        tr.innerHTML = `
          <td><input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleDone(${item.id}, this.checked)"></td>
          <td><input type="checkbox" ${item.res_c ? 'checked' : ''} onchange="toggleRes(${item.id}, this.checked)"></td>
          <td><a href='edit.html?id=${item.id}'>${item.title}</a></td>
          <td>${item.cost}</td>
          <td><span class="link-button" onclick="window.open('${mapLink}', '_blank')">${item.loca}</span></td>
          <td>${formatShortDate(item.date_s)}</td>
          <td>${formatShortDate(item.date_e)}</td>
          <td>${unavailable}</td>
          <td>${item.office || ''}</td>
          <td class="tooltip" title="${item.memo || ''}">ğŸ’¬</td>
          <td><button onclick="deleteSchedule(${item.id})">ì‚­ì œ</button></td>
        `;

        tbody.appendChild(tr);
      });
    }

    async function deleteSchedule(id) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await supabase.from('sche').delete().eq('id', id);
      loadSchedules(document.getElementById('sort').value);
    }

    async function toggleDone(id, checked) {
      await supabase.from('sche').update({ done: checked }).eq('id', id);
    }

    async function toggleRes(id, checked) {
      await supabase.from('sche').update({ res_c: checked }).eq('id', id);
    }

    document.getElementById('sort').addEventListener('change', e => loadSchedules(e.target.value));
    document.getElementById('showDone').addEventListener('change', () => loadSchedules(document.getElementById('sort').value));
    document.getElementById('showReserved').addEventListener('change', () => loadSchedules(document.getElementById('sort').value));
    window.addEventListener('DOMContentLoaded', () => loadSchedules('date_e'));
  </script>
</body>
</html>
